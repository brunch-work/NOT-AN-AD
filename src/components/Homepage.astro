---
import { homepageQuery } from "../gql/queries";
import IconVolume from "../assets/images/svg/volume.svg";
import IconVolumeOff from "../assets/images/svg/volumeoff.svg";
import IconPause from "../assets/images/svg/pause.svg";
import IconPlay from "../assets/images/svg/play.svg";

const response = await fetch("https://graphql.datocms.com/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Accept: "application/json",
    Authorization: `Bearer ${import.meta.env.DATOCMS_API_KEY}`,
  },
  body: JSON.stringify({
    query: homepageQuery,
  }),
});

const json = await response.json();
const { home } = json.data;
---

<div class="home subgrid">
  <div class="reel">
    <div class="lightbox">
      <video
        id="lightbox-video"
        src={home.reel.video.mp4Url}
        autoplay
        loop
        playsinline
        muted></video>
      <div class="video-controls">
        <div class="homepage-controls">
          <div class="main-controls">
            <div class="volume-controls">
              <button
                id="mute-btn"
                class="control-btn"
                aria-label="Toggle mute"
              >
                <IconVolume class="icon-volume" />
                <IconVolumeOff class="icon-volume-off" style="display: none;" />
              </button>

              <div class="custom-volume-slider">
                <div class="volume-track"></div>
                <div class="volume-indicator">
                  <svg width="8" height="12" viewBox="0 0 8 12">
                    <polygon points="0,6 8,0 8,12" fill="currentColor"
                    ></polygon>
                  </svg>
                </div>
              </div>
            </div>
            <div class="playback-controls">
              <button
                id="play-pause-btn"
                class="control-btn"
                aria-label="Play/Pause"
              >
                <IconPause class="icon-pause" />
                <IconPlay class="icon-play" style="display: none;" />
              </button>
            </div>
          </div>

          <div class="time-display">
            <span id="lightbox-current-time">00:00:00:00</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const video = document.getElementById("lightbox-video") as HTMLVideoElement;
  const muteBtn = document.getElementById("mute-btn") as HTMLButtonElement;
  const playPauseBtn = document.getElementById(
    "play-pause-btn",
  ) as HTMLButtonElement;
  const currentTimeDisplay = document.getElementById(
    "lightbox-current-time",
  ) as HTMLSpanElement;
  const durationDisplay = document.getElementById(
    "lightbox-duration",
  ) as HTMLSpanElement;

  // Handle popup toggle
  const projectInfo = document.querySelector(".project-info") as HTMLElement;
  const popup = document.querySelector(".popup") as HTMLElement;

  // Icon elements
  const iconVolume = muteBtn.querySelector(".icon-volume") as HTMLImageElement;
  const iconVolumeOff = muteBtn.querySelector(
    ".icon-volume-off",
  ) as HTMLImageElement;
  const iconPlay = playPauseBtn.querySelector(".icon-play") as HTMLImageElement;
  const iconPause = playPauseBtn.querySelector(
    ".icon-pause",
  ) as HTMLImageElement;

  // Custom volume slider elements
  const volumeSlider = document.querySelector(
    ".custom-volume-slider",
  ) as HTMLElement;
  const volumeIndicator = document.querySelector(
    ".volume-indicator",
  ) as HTMLElement;

  let isDragging = false;

  if (projectInfo && popup) {
    const infoButton = projectInfo.querySelector(
      "#info-btn",
    ) as HTMLButtonElement;

    infoButton.addEventListener("click", () => {
      popup.classList.toggle("visible");

      infoButton.querySelector("svg").classList.toggle("visible");
    });
  }

  // Format time in minutes:seconds
  function formatTime(seconds: number): string {
    const frames = Math.floor((seconds % 1) * 100);
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    const hours = Math.floor(mins / 60);
    return `${hours.toString().padStart(2, "0")}:${mins.toString().padStart(2, "0")}:${secs.toString().padStart(2, "0")}:${frames.toString().padStart(2, "0")}`;
  }

  // Update play/pause icon
  function updatePlayPauseIcon() {
    if (video.paused) {
      iconPlay.style.display = "block";
      iconPause.style.display = "none";
    } else {
      iconPlay.style.display = "none";
      iconPause.style.display = "block";
    }
  }

  // Update volume icon based on volume level
  function updateVolumeIcon() {
    if (video.muted || video.volume === 0) {
      iconVolume.style.display = "none";
      iconVolumeOff.style.display = "block";
    } else {
      iconVolume.style.display = "block";
      iconVolumeOff.style.display = "none";
    }
  }

  // Update volume indicator position
  function updateVolumeIndicator() {
    const volume = video.muted ? 0 : video.volume;
    const percentage = volume * 100;
    volumeIndicator.style.bottom = `${percentage}%`;
  }

  // Set volume from mouse position
  function setVolumeFromEvent(e: MouseEvent) {
    const rect = volumeSlider.getBoundingClientRect();
    const y = rect.bottom - e.clientY; // Inverted: bottom is 0, top is max
    const percentage = Math.max(0, Math.min(100, (y / rect.height) * 100));
    const volume = percentage / 100;

    video.volume = volume;

    // Unmute if user adjusts volume above 0
    if (volume > 0 && video.muted) {
      video.muted = false;
    } else if (volume === 0) {
      video.muted = true;
    }

    updateVolumeIcon();
    updateVolumeIndicator();
  }

  // Play/Pause button
  playPauseBtn.addEventListener("click", () => {
    if (video.paused) {
      video.play();
    } else {
      video.pause();
    }
    updatePlayPauseIcon();
  });

  // Update icon when video plays/pauses (from other sources)
  video.addEventListener("play", updatePlayPauseIcon);
  video.addEventListener("pause", updatePlayPauseIcon);

  // Mouse down on slider
  volumeSlider.addEventListener("mousedown", (e) => {
    e.preventDefault();
    isDragging = true;
    setVolumeFromEvent(e);
  });

  // Mouse move anywhere (for dragging)
  window.addEventListener("mousemove", (e) => {
    if (isDragging) {
      e.preventDefault();
      setVolumeFromEvent(e);
    }
  });

  // Mouse up anywhere (stop dragging)
  window.addEventListener("mouseup", () => {
    if (isDragging) {
      isDragging = false;
    }
  });

  // Initialize video
  video.addEventListener("loadedmetadata", () => {
    durationDisplay.textContent = formatTime(video.duration);
    updateVolumeIndicator();
  });

  // Update time display on every frame
  video.addEventListener("timeupdate", () => {
    currentTimeDisplay.textContent = formatTime(video.currentTime);
  });

  // Mute/unmute toggle
  muteBtn.addEventListener("click", () => {
    if (video.muted) {
      video.muted = false;
      // Set volume to 50% if still at 0
      if (video.volume === 0) {
        video.volume = 0.5;
      }
    } else {
      video.muted = true;
    }
    updateVolumeIcon();
    updateVolumeIndicator();
  });

  // Update volume slider when video volume changes
  video.addEventListener("volumechange", () => {
    updateVolumeIcon();
    updateVolumeIndicator();
  });

  // Initialize
  updatePlayPauseIcon();
  updateVolumeIcon();
  updateVolumeIndicator();
</script>
