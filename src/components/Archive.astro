---
import { archiveQuery, lightboxQuery } from "../gql/queries";
import { Lightbox } from "./Lightbox.jsx";

const response = await fetch("https://graphql.datocms.com/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Accept: "application/json",
    Authorization: `Bearer ${import.meta.env.DATOCMS_API_KEY}`,
  },
  body: JSON.stringify({
    query: archiveQuery,
  }),
});

const json = await response.json();
const data = json.data;
const assets = data.archive.assets;
const initialIndex = 0;

// Fetch project data for each asset
const projectDataMap = {};
for (const asset of assets) {
  try {
    const projectResponse = await fetch("https://graphql.datocms.com/", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Accept: "application/json",
        Authorization: `Bearer ${import.meta.env.DATOCMS_API_KEY}`,
      },
      body: JSON.stringify({
        query: lightboxQuery,
        variables: {
          id: [asset.id],
        },
      }),
    });

    const projectJson = await projectResponse.json();
    if (projectJson.data?.project) {
      projectDataMap[asset.id] = projectJson.data.project;
    }
  } catch (error) {
    console.error(`Error fetching project for asset ${asset.id}:`, error);
  }
}
---

<div class="subgrid archive">
  {
    assets.map((asset, index) => {
      if (asset.format === "jpg" || asset.format === "png") {
        return (
          <div class="archive-item">
            <button
              data-lightbox-trigger
              data-asset-index={index}
              aria-label={`View ${asset.alt || "image"}`}
            >
              <img src={asset.url} alt={asset.alt} />
            </button>
          </div>
        );
      }
      if (
        asset.format === "mp4" ||
        asset.format === "webm" ||
        asset.format === "mov"
      ) {
        return (
          <div class="archive-item">
            <button
              data-lightbox-trigger
              data-asset-index={index}
              data-video-preview
              aria-label={`View ${asset.alt || "video"}`}
            >
              <video src={asset.video.mp4Url} muted preload="metadata" />
            </button>
          </div>
        );
      }
    })
  }
</div>
<dialog id="lightbox-dialog" class="lightbox-dialog">
  <div class="grid">
    <div class="subgrid">
      <div id="lightbox-wrapper" class="lightbox-wrapper">
        <Lightbox
          client:load
          assets={assets}
          index={initialIndex}
          projectDataMap={projectDataMap}
        />
      </div>
    </div>
  </div>
</dialog>

<script>
  const triggers = document.querySelectorAll("[data-lightbox-trigger]");
  const dialog = document.getElementById("lightbox-dialog");

  triggers.forEach((trigger) => {
    trigger.addEventListener("click", (e) => {
      const index = parseInt(
        trigger.getAttribute("data-asset-index") || "0",
        10,
      );

      // Dispatch custom event to update the lightbox index
      window.dispatchEvent(
        new CustomEvent("openLightbox", { detail: { index } }),
      );

      if (dialog) {
        dialog.classList.toggle("show");
      }
    });
  });

  // Close dialog on outside click
  if (dialog) {
    dialog.addEventListener("click", (e) => {
      const rect = dialog.getBoundingClientRect();
      const isInDialog =
        rect.top <= e.clientY &&
        e.clientY <= rect.top + rect.height &&
        rect.left <= e.clientX &&
        e.clientX <= rect.left + rect.width;

      if (!isInDialog) {
        dialog.close();
      }
    });
  }

  // Video preview on hover
  const videoTriggers = document.querySelectorAll("[data-video-preview]");

  videoTriggers.forEach((trigger) => {
    const video = trigger.querySelector("video");
    if (!video) return;

    let isHovering = false;

    const handleTimeUpdate = () => {
      if (isHovering && video.currentTime >= 2) {
        video.currentTime = 0;
      }
    };

    trigger.addEventListener("mouseenter", async () => {
      isHovering = true;
      video.currentTime = 0;
      video.addEventListener("timeupdate", handleTimeUpdate);

      try {
        await video.play();
      } catch (error) {
        console.error("Error playing video preview:", error);
      }
    });

    trigger.addEventListener("mouseleave", () => {
      isHovering = false;
      video.pause();
      video.currentTime = 0;
      video.removeEventListener("timeupdate", handleTimeUpdate);
    });
  });
</script>
