---
import { archiveQuery } from "../gql/queries";
import Lightbox from "./Lightbox.astro";

const response = await fetch("https://graphql.datocms.com/", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    Accept: "application/json",
    Authorization: `Bearer ${import.meta.env.DATOCMS_API_KEY}`,
  },
  body: JSON.stringify({
    query: archiveQuery,
  }),
});

const json = await response.json();
const data = json.data;
const assets = data.archive.assets;
const index = 4;
---

<div class="subgrid archive">
  {
    assets.map((asset, index) => {
      if (asset.format === "jpg" || asset.format === "png") {
        return (
          <div class="archive-item">
            <button
              data-lightbox-trigger
              data-asset-index={index}
              aria-label={`View ${asset.alt || "image"}`}
            >
              <img src={asset.url} alt={asset.alt} />
            </button>
          </div>
        );
      }
      if (
        asset.format === "mp4" ||
        asset.format === "webm" ||
        asset.format === "mov"
      ) {
        return (
          <div class="archive-item">
            <button
              data-lightbox-trigger
              data-asset-index={index}
              aria-label={`View ${asset.alt || "video"}`}
            >
              <video src={asset.video.mp4Url} muted />
            </button>
          </div>
        );
      }
    })
  }
</div>
<dialog id="lightbox-dialog" class="lightbox-dialog">
  <div class="grid">
    <div class="subgrid">
      <div class="lightbox-wrapper">
        <Lightbox assets={assets} isHomepage={false} index={index} />
      </div>
    </div>
  </div>
</dialog>

<script define:vars={{ assets, index }}></script>
